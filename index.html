<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<div style="margin-left: 10%; margin-right: 10%; ">
    <h1>Output</h1>
    <input type="button" onclick="run()" value="Send Request">
    <div id="output" style="background-color: antiquewhite">
        ...
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>


<script type="text/javascript" src="bower_components/async/dist/async.js"></script>
<script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
<script type="text/javascript">
	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyDmuJBICvJPCpq3D0FPsan7IfzjAXhmz5c",
		authDomain: "comp6950a2.firebaseapp.com",
		databaseURL: "https://comp6950a2.firebaseio.com",
		storageBucket: "comp6950a2.appspot.com",
		messagingSenderId: "686237011839"
	};

	var url = 'https://test806003586.servicebus.windows.net/testqueue2/subscriptions/2f1aceda-05c5-4e53-857c-b7b248868a29/resourceGroups/sbTest/providers/Microsoft.ServiceBus/namespaces/test806003586/queues/testqueue2?api-version=2015-08-01';

	firebase.initializeApp(config);

	/**
     *
	 * @param url
	 * @param params eg lorem=ipsum&name=binny
	 */
	function post(url, params){
	    var http = new XMLHttpRequest();
	    http.open("POST", url, true);

        //Send the proper header information along with the request
	    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

	    http.onreadystatechange = function() {//Call a function when the state changes.
		    if(http.readyState == 4 && http.status == 200) {
			    print(http.responseText);
		    }
	    };

	    http.send(params);
    }

    function put(url, data){
	    $.ajax({
		    url: url,
		    type: 'PUT',
            data: data,
		    success: function(result) {
			    console.log(result)
		    },
            error: function(err){
		    	console.log(err);
            }
	    });
    }

	function readTextFile(file, callback) {
		var rawFile = new XMLHttpRequest();
		rawFile.overrideMimeType("application/json");
		rawFile.open("GET", file, true);
		rawFile.onreadystatechange = function() {
			if (rawFile.readyState === 4 && rawFile.status == "200") {
				callback(rawFile.responseText);
			}
		};
		rawFile.send(null);
	}

    function print(str){
    	var out = document.getElementById('output');
    	var html = out.innerHTML;
    	html+="<br>"+str;
    	out.innerHTML = html;
    }



    function run(){
	    put(url, "data=hi");

    	document.getElementById('output').innerHTML='';
	    readTextFile("data.json", function(text){

		    var q = async.queue(function (item, callback) {
			    callback(item);
		    }, 1000);

		    var data = JSON.parse(text);
            q.push(data, function(item) {
//				    firebase.database().ref('/data').push(item);
                post('https://test806003586.servicebus.windows.net/testqueue2', item);
            });


	    });
    }



	// create a queue object with concurrency 2


//
//
//	// assign a callback
//	q.drain = function() {
//		print('all items have been processed');
//	}
//
//	// add some items to the queue
//

//	q.push({name: 'bar'}, function (err) {
//		print('finished processing bar');
//	});
//
//	// add some items to the queue (batch-wise)
//
//	q.push([{name: 'baz'},{name: 'bay'},{name: 'bax'}], function (err) {
//		print('finished processing item');
//	});
//
//	// add some items to the front of the queue
//
//	q.unshift({name: 'bar'}, function (err) {
//		print('finished processing bar');
//	});

</script>
</body>
</html>